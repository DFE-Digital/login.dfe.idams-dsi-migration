parameters:
 - name: applicationName
   type: string
 - name: serviceConnection
   type: string
 - name: subscriptionId
   type: string

jobs:
- deployment: packageAndDeploy
  displayName: 'Package and Deploy : ${{parameters.environmentName}}'
  environment: '${{parameters.environmentName}}'
  variables:
  - '${{ each variableGroup in parameters.variableGroups }}': 
  - group: '${{variableGroup}}'
    - job: Deploy
        displayName: Deploy
        
        steps:
              -  task: AzureResourceManagerTemplateDeployment@3
                 inputs:
                  deploymentScope: 'Resource Group'
                  azureResourceManagerConnection: '${{parameters.serviceConnection}}'
                  subscriptionId: '${{parameters.subscriptionId}}'
                  action: 'Create Or Update Resource Group'
                  resourceGroupName: '$(platformGlobalIdentifier)-$(environmentId)-${{parameters.applicationName}}'
                  location: 'West Europe'
                  templateLocation: 'Linked artifact'
                  csmFile: '$(System.DefaultWorkingDirectory)\**\LogicApp.json'
                  csmParametersFile: '$(System.DefaultWorkingDirectory)\**\LogicApp.parameters.json'
                  overrideParameters: '-tags "$(tags)" -logicAppName $(logicappname) -logicAppLocation $(logicapplocation) -azureblob_1_Connection_Name $(azureblobconnectionname) -azureblob_1_Connection_DisplayName $(azureblobconnectiondisplayname) -azureblob_1_accountName $(azureblobaccountname) -azureblob_1_accessKey $(azureblobaccesskey) -azureblob_1_authType $(azureblobauthtype) -azureblob_1_privacySetting $(azureblobprivacysetting) -office365_1_Connection_Name $(office365connectionname) -office365_1_Connection_DisplayName $(office365connectiondisplayname) '
                  deploymentMode: 'Incremental'