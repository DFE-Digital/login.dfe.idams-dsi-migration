parameters:
 - name: applicationName
   type: string
 - name: environmentId
   type: string
 - name: environmentName
   type: string
 - name: location
   type: string
 - name: serviceConnection
   type: string
 - name: subscriptionId
   type: string
 - name: variableGroups
   type: object
 

jobs:
- deployment: packageAndDeploy
  displayName: 'Package and Deploy : ${{parameters.environmentName}}'
  environment: '${{parameters.environmentName}}'
  

- job: Deploy
  displayName: Deploy
  variables: 
  - name: applicationResourceGroupName
    value: '$(platformGlobalIdentifier)${{parameters.environmentId}}-${{parameters.applicationName}}'      
  steps:
   - task: AzurePowerShell@5
     displayName: Create ResourceGroup with tags
     inputs:
        azureSubscription: ${{parameters.serviceConnection}}
        ScriptType: 'InlineScript'
        Inline: 'New-AzResourceGroup -Name $(applicationResourceGroupName) -Location "${{parameters.location}}" -Tag $(Tags) -Force'
        azurePowerShellVersion: 'LatestVersion'
   - task: AzureRmWebAppDeployment@4
     displayName: 'Deploy Azure Function'
     inputs:
        azureSubscription: ${{parameters.serviceConnection}}
        appType: functionApp
        WebAppName: 's141d-Pirean.azdo-deployment'                 
         package: $(Pipeline.Workspace)/s/Function_$(Build.BuildId).zip
        appSettings: '-FUNCTIONS_WORKER_RUNTIME "dotnet"' 
        enableCustomDeployment: true
        RemoveAdditionalFilesFlag: true
  
