name: $(BuildDefinitionName)_tag-$(BuildID)_at-$(Date:yyyyMMdd)$(Rev:.r)
resources:
  repositories:
    - repository: self
      persistCredentials: true
      clean: true
    - repository: devopsTemplates
      type: github
      endpoint: DfE-Digital
      name: DFE-Digital/login.dfe.idams-dsi-migration
      ref: master

variables:
- group: platform-global
- group: platform-Dev
- group: platform-dev-idamsdsiapp

stages:
- stage: importorgsdb
  displayName: Import Organisations Database
  jobs:
    - deployment: importorgsdb
      displayName: Import Organisations Database
      pool:
        vmImage: ubuntu-latest
      environment: 'dev'
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self
              - checkout: devopsTemplates
              - task: AzureCLI@2
                displayName: 'Azure CLI - Promote SQL Server Credentials'
                inputs:
                  azureSubscription: 's141d-Pirean.azdo-deployment'
                  scriptType: pscore
                  scriptLocation: inlineScript
                  inlineScript: |
                  
                    Write-Host "##vso[task.setvariable variable=SQL_User_Name]$env:organisationsdbUserName"
                    Write-Host "##vso[task.setvariable variable=SQL_Password]$env:organisationsdbPassword"
                    
                  addSpnToEnvironment: true
              - task: AzurePowerShell@5
                displayName: Import Organisations Database
                inputs:
                  azureSubscription: 's141d-Pirean.azdo-deployment'
                  ScriptType: 'FilePath'
                  ScriptPath: ./login.dfe.idams-dsi-migration/powershell/Import-from-bacpac-to-sql-db.ps1
                  ScriptArguments: '-resourceGroupName s141d02-shd -serverName $(organisationsSqlHostName) -databaseName $(organisationsdbName) -storageAccountName $(azureblobaccountname) -storageContainerName $(blobsqlcontainername) -bacpacFilename $(azureblobbacpacfilename) -adminSqlLogin $(SQL_User_Name) -adminpwd $(SQL_Password)'
                  azurePowerShellVersion: 'LatestVersion'
                  pwsh: true
     